version: '3.8'

volumes:
  postgres_data: {}
  smartbudget_db_volume: {} # Volume to store the DuckDB file

services:
  postgres:
    image: postgres:13
    environment:
      - POSTGRES_USER=superset
      - POSTGRES_PASSWORD=superset
      - POSTGRES_DB=superset
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superset"]
      interval: 10s
      timeout: 5s
      retries: 5

  superset:
    image: apache/superset
    ports:
      - "8088:8080"
    volumes:
      # Mount a local folder to install drivers and persist config
      - ./superset:/app/superset
      # Mount the DuckDB volume (read-only)
      - smartbudget_db_volume:/app/data:ro
    environment:
      - SUPERSET_SECRET_KEY=change_me_to_a_real_secret_key
      # Tell Superset to load config from the mounted volume
      - SUPERSET_CONFIG_PATH=/app/superset/superset_config.py
    depends_on:
      postgres:
        condition: service_healthy
    command: >
      /bin/sh -c "pip install duckdb-engine && superset-app"

  etl:
    build: .
    volumes:
      # Mount the DuckDB volume to write the DB file
      - smartbudget_db_volume:/app/data
      # Mount the sample data as read-only
      - ./data:/app/data/ro:ro
